---
// Simple transcript component that shows user and assistant messages
// Displays only a few lines, scrolling up and fading out
---

<div id="transcript-container" class="transcript-container">
  <div id="transcript-content" class="transcript-content"></div>
</div>

<style>
  .transcript-container {
    position: fixed;
    top: 60%; /* Position under the logo (logo is centered) */
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 600px;
    z-index: 100;
    pointer-events: none; /* Don't block interactions */
  }

  .transcript-content {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
    text-align: center;
    min-height: 20px; /* Ensure container has minimum height */
  }

  .transcript-line {
    font-size: 14px;
    line-height: 1.4;
    color: #ffffff !important; /* Force white text */
    padding: 4px 12px;
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.6) !important; /* Darker background for better contrast */
    backdrop-filter: blur(4px);
    max-width: 100%;
    word-wrap: break-word;
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    animation: slideUpFade 3s ease-out forwards, streaming 2s ease-in-out infinite;
    overflow: hidden;
    position: relative;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5); /* Add text shadow for better visibility */
  }

  /* Streaming/flowing text effect */
  @keyframes streaming {
    0%, 100% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
  }

  /* Add a subtle shimmer effect for streaming */
  .transcript-line::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.1),
      transparent
    );
    animation: shimmer 2s ease-in-out infinite;
  }

  @keyframes shimmer {
    0% {
      left: -100%;
    }
    100% {
      left: 100%;
    }
  }

  .transcript-line.user {
    color: #ffffff !important; /* Force white text */
    background: rgba(0, 0, 0, 0.6) !important; /* Ensure background is visible */
  }

  .transcript-line.assistant {
    color: #ffffff !important; /* Force white text */
    background: rgba(0, 0, 0, 0.6) !important; /* Ensure background is visible */
  }

  @keyframes slideUpFade {
    0% {
      opacity: 1;
      transform: translateY(0);
    }
    60% {
      opacity: 1;
      transform: translateY(0);
    }
    100% {
      opacity: 0;
      transform: translateY(-20px);
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .transcript-container {
      top: 65%; /* Adjust for mobile */
      width: 95%;
    }

    .transcript-line {
      font-size: 12px;
      padding: 3px 10px;
    }
  }
</style>

<script>
  const MAX_LINES = 3; // Maximum number of lines to show
  const transcriptContent = document.getElementById("transcript-content");
  let messageQueue: Array<{ text: string; type: "user" | "assistant" }> = [];

  function addTranscriptLine(text: string, type: "user" | "assistant") {
    if (!transcriptContent) {
      console.warn("transcriptContent not found");
      return;
    }

    // Clean and truncate text
    const cleanText = text.trim().slice(0, 100); // Max 100 chars per line
    if (!cleanText) return;

    // Create new line element
    const line = document.createElement("div");
    line.className = `transcript-line ${type}`;
    
    // Streaming text effect - reveal characters one by one
    let currentIndex = 0;
    const streamingInterval = setInterval(() => {
      if (currentIndex <= cleanText.length) {
        line.textContent = cleanText.slice(0, currentIndex);
        currentIndex++;
      } else {
        clearInterval(streamingInterval);
      }
    }, 30); // Adjust speed (lower = faster)

    // Add to DOM immediately (text will stream in)
    transcriptContent.appendChild(line);
    console.log("Added transcript line:", cleanText);

    // Remove old lines if we exceed max
    const lines = transcriptContent.querySelectorAll(".transcript-line");
    if (lines.length > MAX_LINES) {
      lines[0].remove();
    }

    // Auto-remove after animation completes
    setTimeout(() => {
      if (line.parentNode) {
        line.style.opacity = "0";
        line.style.transform = "translateY(-20px)";
        setTimeout(() => {
          line.remove();
        }, 500);
      }
    }, 2500);
  }

  // Listen for Vapi events via custom events
  window.addEventListener("vapi-transcript", ((event: CustomEvent) => {
    if (event.detail && event.detail.text && event.detail.type) {
      addTranscriptLine(event.detail.text, event.detail.type);
    }
  }) as EventListener);

  // Also listen for Vapi message events directly if available
  if (window.Vapi) {
    // This will be set up when Vapi instance is created
    // We'll dispatch custom events from VoiceChatButton
  }

  // DUMMY TEXT FOR TESTING - Remove this when done testing
  function initDummyText() {
    if (!transcriptContent) {
      console.warn("transcriptContent not ready, retrying...");
      setTimeout(initDummyText, 100);
      return;
    }
    
    console.log("Initializing dummy transcript text");
    setTimeout(() => {
      addTranscriptLine("Hello, how can I help you today?", "assistant");
      setTimeout(() => {
        addTranscriptLine("I'd like to know more about your services", "user");
        setTimeout(() => {
          addTranscriptLine("I'd be happy to tell you about our services. We offer a wide range of solutions.", "assistant");
        }, 2000);
      }, 2000);
    }, 500);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initDummyText);
  } else {
    // Wait a bit to ensure DOM is fully ready
    setTimeout(initDummyText, 100);
  }
</script>


---
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <div class="page-container">
    <div id="clerk-sign-in"></div>
    <div id="loading-message" style="color: #fff; position: absolute;">
      Loading sign-in...
    </div>
  </div>
</Layout>

<script>
  function initSignIn() {
    const container = document.getElementById("clerk-sign-in");
    const loadingMessage = document.getElementById("loading-message");

    if (!container) {
      console.error("Sign-in container not found");
      return;
    }

    function hideLoading() {
      if (loadingMessage) {
        loadingMessage.style.display = "none";
      }
    }

    function checkComponentsReady() {
      if (!window.Clerk) {
        return false;
      }

      // Check if mountSignIn is available (indicates components are ready)
      if (typeof window.Clerk.mountSignIn === "function") {
        return true;
      }

      // Fallback: check components API
      if (
        window.Clerk.components &&
        window.Clerk.components.signIn &&
        typeof window.Clerk.components.signIn.mount === "function"
      ) {
        return true;
      }

      return false;
    }

    async function waitForClerkComponents() {
      // If Clerk.load() is available, use it to ensure components are ready
      if (window.Clerk && typeof window.Clerk.load === "function") {
        try {
          await window.Clerk.load();
        } catch (error) {
          console.error("Error loading Clerk:", error);
        }
      }

      // Poll until components are ready
      let attempts = 0;
      const maxAttempts = 50;

      while (!checkComponentsReady() && attempts < maxAttempts) {
        await new Promise((resolve) => setTimeout(resolve, 100));
        attempts++;
      }

      return checkComponentsReady();
    }

    async function mountClerk() {
      if (!container) {
        return false;
      }

      // Wait for Clerk components to be ready
      const componentsReady = await waitForClerkComponents();
      if (!componentsReady) {
        console.warn("Clerk components not ready after waiting");
        return false;
      }

      try {
        // Try mountSignIn first (preferred method)
        if (typeof window.Clerk.mountSignIn === "function") {
          window.Clerk.mountSignIn(container as HTMLDivElement, {
            routing: "path",
            path: "/sign-in",
            signUpUrl: "/sign-up",
          });
          console.log("Clerk sign-in mounted successfully");
          hideLoading();
          return true;
        }

        // Fallback to components API
        if (
          window.Clerk.components &&
          window.Clerk.components.signIn &&
          typeof window.Clerk.components.signIn.mount === "function"
        ) {
          window.Clerk.components.signIn.mount(container as HTMLDivElement, {
            routing: "path",
            path: "/sign-in",
            signUpUrl: "/sign-up",
          });
          console.log(
            "Clerk sign-in mounted successfully (via components API)"
          );
          hideLoading();
          return true;
        }
      } catch (error) {
        console.error("Error mounting Clerk sign-in:", error);
        if (loadingMessage) {
          loadingMessage.textContent =
            "Error loading sign-in. Please refresh the page.";
          loadingMessage.style.color = "#ff0000";
        }
        return false;
      }

      return false;
    }

    // Try to mount immediately if Clerk is already available
    mountClerk().then((success) => {
      if (success) {
        return;
      }

      // Listen for clerk-loaded event from Layout
      window.addEventListener("clerk-loaded", async () => {
        console.log("Clerk loaded event received");
        await mountClerk();
      });

      // Fallback: poll for Clerk availability
      let attempts = 0;
      const maxAttempts = 100;
      const checkInterval = setInterval(async () => {
        attempts++;
        const success = await mountClerk();
        if (success) {
          clearInterval(checkInterval);
        } else if (attempts >= maxAttempts) {
          clearInterval(checkInterval);
          console.warn(
            "Clerk sign-in component not available after",
            maxAttempts,
            "attempts"
          );
          if (loadingMessage) {
            loadingMessage.textContent =
              "Unable to load sign-in. Please check your connection and refresh.";
            loadingMessage.style.color = "#ffaa00";
          }
        }
      }, 200);
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSignIn);
  } else {
    initSignIn();
  }
</script>

<style>
  .page-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: #000;
    padding-top: 320px;
  }

  @media screen and (min-width: 768px) {
    .page-container {
      padding-top: 400px;
    }
  }

  @media screen and (min-width: 1024px) {
    .page-container {
      padding-top: 480px;
    }
  }
</style>
